
<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>محلات أيمن أبو الشوارب — مزامنة سحابية</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#007bff">
<style>
  body { background:#f7f7fb }
  .card { box-shadow:0 6px 18px rgba(0,0,0,.06); border:none }
  .chip { display:inline-flex; align-items:center; gap:.35rem; background:#e9f2ff; border:1px solid #cfe4ff; padding:.25rem .6rem; border-radius:50rem; margin:.2rem .2rem 0 0; font-size:.9rem }
  .chip .x { cursor:pointer }
  .currency::after { content:" شيقل"; color:#666; font-weight:500 }
  .stat { font-weight:800; font-size:1.25rem }
  .weekday { min-height:84px }
  .brand { font-weight:800; letter-spacing:.3px }
  .table thead th{ position:sticky; top:0; background:#fff; z-index:1 }
  .pointer{cursor:pointer}
</style>
</head>
<body>
<nav class="navbar bg-white border-bottom sticky-top">
  <div class="container-fluid">
    <span class="navbar-brand brand"><i class="bi bi-shop me-2"></i>محلات أيمن أبو الشوارب — سحابي</span>
    <div class="d-flex align-items-center gap-2">
      <div class="input-group input-group-sm" style="width:260px">
        <span class="input-group-text">رمز المشترك</span>
        <input id="workspace" class="form-control" placeholder="مثلاً AYMAN-1">
        <button id="btnJoin" class="btn btn-primary">دخول</button>
      </div>
      <span id="who" class="badge bg-info">غير مسجّل</span>
      <button class="btn btn-outline-secondary btn-sm" onclick="window.print()"><i class="bi bi-printer"></i></button>
    </div>
  </div>
</nav>

<main class="container my-4">
  <div class="alert alert-info py-2">
    افتح التطبيق على الجهازين واكتب نفس <strong>رمز المشترك</strong> (مثلًا <code>AYMAN-1</code>) ثم اضغط <strong>دخول</strong>، كل التعديلات ستتزامن فورًا بين الجهازين.
  </div>
  <div class="row g-3">
    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title mb-2">ملخص سريع</h5>
          <div class="mb-2">
            <label class="form-label">المورد</label>
            <select id="selSupplier" class="form-select"></select>
          </div>
          <div class="row g-2 text-center">
            <div class="col-6"><div class="p-3 border rounded bg-white">
              <div class="text-muted">إجمالي الفواتير</div><div id="sumInv" class="stat currency">0</div></div></div>
            <div class="col-6"><div class="p-3 border rounded bg-white">
              <div class="text-muted">إجمالي الدفعات</div><div id="sumPay" class="stat currency">0</div></div></div>
            <div class="col-6"><div class="p-3 border rounded bg-white">
              <div class="text-muted">الافتتاحي</div><div id="open" class="stat currency">0</div></div></div>
            <div class="col-6"><div class="p-3 border rounded bg-white">
              <div class="text-muted">الرصيد الحالي</div><div id="bal" class="stat currency">0</div></div></div>
          </div>
          <div class="d-grid gap-2 mt-3">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#mInvoice"><i class="bi bi-receipt"></i> إضافة فاتورة</button>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#mPayment"><i class="bi bi-cash-coin"></i> إضافة دفعة</button>
            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#mSupplier"><i class="bi bi-person-plus"></i> إضافة/تعديل مورد</button>
          </div>
          <hr>
          <div>
            <label class="form-label">إظهار الدفعات بتاريخ</label>
            <input type="date" id="filterDate" class="form-control">
            <div id="paymentsByDate" class="mt-2 small"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-8">
      <div class="card mb-3">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="card-title mb-0">تقويم الأسبوع</h5>
            <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#mCalendar"><i class="bi bi-calendar-plus"></i> إضافة إلى التقويم</button>
          </div>
          <div class="row g-2">
            <div class="col-6 col-md-4"><div class="p-2 border rounded bg-white weekday"><div class="text-muted small mb-1">السبت</div><div id="d-sat"></div></div></div>
            <div class="col-6 col-md-4"><div class="p-2 border rounded bg-white weekday"><div class="text-muted small mb-1">الأحد</div><div id="d-sun"></div></div></div>
            <div class="col-6 col-md-4"><div class="p-2 border rounded bg-white weekday"><div class="text-muted small mb-1">الاثنين</div><div id="d-mon"></div></div></div>
            <div class="col-6 col-md-4"><div class="p-2 border rounded bg-white weekday"><div class="text-muted small mb-1">الثلاثاء</div><div id="d-tue"></div></div></div>
            <div class="col-6 col-md-4"><div class="p-2 border rounded bg-white weekday"><div class="text-muted small mb-1">الأربعاء</div><div id="d-wed"></div></div></div>
            <div class="col-6 col-md-4"><div class="p-2 border rounded bg-white weekday"><div class="text-muted small mb-1">الخميس</div><div id="d-thu"></div></div></div>
            <div class="col-6 col-md-4"><div class="p-2 border rounded bg-white weekday"><div class="text-muted small mb-1">الجمعة</div><div id="d-fri"></div></div></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tSup">الموردون</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tInv">الفواتير</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tPay">الدفعات</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tRpt">تقرير</button></li>
          </ul>
          <div class="tab-content pt-3">
            <div class="tab-pane fade show active" id="tSup">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <input id="supSearch" class="form-control w-50" placeholder="ابحث عن اسم المورد...">
                <button class="btn btn-outline-dark btn-sm" data-bs-toggle="modal" data-bs-target="#mGlobalReport">
                  <i class="bi bi-graph-up"></i> تقرير شامل
                </button>
              </div>
              <div class="table-responsive" style="max-height:380px">
                <table class="table table-hover align-middle">
                  <thead class="table-light"><tr><th>#</th><th>الاسم</th><th>افتتاحي</th><th>مندوب</th><th>ملاحظات</th><th>إجراءات</th></tr></thead>
                  <tbody id="supBody"></tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="tInv">
              <div class="table-responsive" style="max-height:380px">
                <table class="table table-striped align-middle">
                  <thead class="table-light"><tr><th>التاريخ</th><th>الفاتورة</th><th>المورد</th><th>المبلغ</th><th>ملاحظات</th><th></th></tr></thead>
                  <tbody id="invBody"></tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="tPay">
              <div class="table-responsive" style="max-height:380px">
                <table class="table table-striped align-middle">
                  <thead class="table-light"><tr><th>التاريخ</th><th>المورد</th><th>المندوب</th><th>المبلغ</th><th>طريقة</th><th>ملاحظات</th><th></th></tr></thead>
                  <tbody id="payBody"></tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="tRpt">
              <div class="row g-2 mb-2">
                <div class="col-md-4"><div class="p-3 border rounded bg-light">
                  <div class="text-muted">إجمالي الديون (أرصدة موجبة)</div><div id="rDebt" class="stat currency">0</div></div></div>
                <div class="col-md-4"><div class="p-3 border rounded bg-light">
                  <div class="text-muted">إجمالي الدفعات</div><div id="rPays" class="stat currency">0</div></div></div>
                <div class="col-md-4"><div class="p-3 border rounded bg-light">
                  <div class="text-muted">الرصيد الكلي</div><div id="rBal" class="stat currency">0</div></div></div>
              </div>
              <div class="table-responsive" style="max-height:380px">
                <table class="table table-hover align-middle">
                  <thead class="table-light"><tr><th>المورد</th><th>إجمالي فواتير</th><th>إجمالي دفعات</th><th>افتتاحي</th><th>الرصيد الحالي</th></tr></thead>
                  <tbody id="rBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</main>

<div class="modal fade" id="mGlobalReport" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">تقرير شامل — جميع الحسابات والدفعات</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row g-2 mb-3">
          <div class="col-md-6">
            <div class="p-3 border rounded bg-light">
              <div class="text-muted">مجموع أرصدة جميع الموردين</div>
              <div id="grTotalBalances" class="stat currency">0</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="p-3 border rounded bg-light">
              <div class="text-muted">إجمالي كل الدفعات</div>
              <div id="grTotalPayments" class="stat currency">0</div>
            </div>
          </div>
        </div>
        <h6 class="mt-2">جميع الدفعات</h6>
        <div class="table-responsive" style="max-height:420px">
          <table class="table table-striped align-middle">
            <thead class="table-light">
              <tr><th>التاريخ</th><th>المورد</th><th>المندوب</th><th>الطريقة</th><th>المبلغ</th><th>ملاحظات</th></tr>
            </thead>
            <tbody id="grPaymentsBody"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

<script>
const FIREBASE_CONFIG = {"apiKey": "AIzaSyBcPPHsTwtCPIuTxVWxAZnXUbKu9L572eU", "authDomain": "simple-ledger-17e3f.firebaseapp.com", "projectId": "simple-ledger-17e3f", "storageBucket": "simple-ledger-17e3f.firebasestorage.app", "messagingSenderId": "453432208264", "appId": "1:453432208264:web:e701501a9bb2288822683d", "measurementId": "G-T7PQTXDV3H"};

let app, db, auth, user=null, WORKSPACE=localStorage.getItem('workspace')||'';
function initFirebase(){
  app = firebase.initializeApp(FIREBASE_CONFIG);
  db = firebase.firestore();
  auth = firebase.auth();
  if (db.enablePersistence) { db.enablePersistence({ synchronizeTabs: true }).catch(()=>{}); }
  auth.signInAnonymously().then(cred=>{ user=cred.user; document.getElementById('who').textContent='مسجّل'; }).catch(()=>{ document.getElementById('who').textContent='لم يتم الدخول'; });
}
initFirebase();

document.getElementById('btnJoin').addEventListener('click', ()=>{
  const val=document.getElementById('workspace').value.trim();
  if(!val){ alert('أدخل رمز المشترك'); return; }
  WORKSPACE=val; localStorage.setItem('workspace', WORKSPACE);
  attachRealtime();
});

function wsCol(col){ return db.collection('workspaces').doc(WORKSPACE).collection(col); }
function wsDoc(doc){ return db.collection('workspaces').doc(WORKSPACE).collection('meta').doc(doc); }

let state = { suppliers:[], invoices:[], payments:[], week:{sat:[],sun:[],mon:[],tue:[],wed:[],thu:[],fri:[]} };
let unsub = {sup:null, inv:null, pay:null, week:null};

async function attachRealtime(){
  if(!db || !WORKSPACE) return;
  await db.collection('workspaces').doc(WORKSPACE).set({ createdAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
  if (unsub.sup) unsub.sup(); unsub.sup = wsCol('suppliers').orderBy('name').onSnapshot(snap=>{ state.suppliers = snap.docs.map(d=>({id:d.data().id, ...d.data()})); rerender(); });
  if (unsub.inv) unsub.inv(); unsub.inv = wsCol('invoices').orderBy('date','desc').onSnapshot(snap=>{ state.invoices = snap.docs.map(d=>({id:d.data().id, ...d.data()})); rerender(); });
  if (unsub.pay) unsub.pay(); unsub.pay = wsCol('payments').orderBy('date','desc').onSnapshot(snap=>{ state.payments = snap.docs.map(d=>({id:d.data().id, ...d.data()})); rerender(); });
  if (unsub.week) unsub.week(); unsub.week = wsDoc('week').onSnapshot(doc=>{ state.week = doc.data() || {sat:[],sun:[],mon:[],tue:[],wed:[],thu:[],fri:[]}; rerender(); });
}

const $=s=>document.querySelector(s);
const today=()=> new Date().toISOString().slice(0,10);
const fmt=n=> Number(n||0).toLocaleString('ar-EG',{maximumFractionDigits:2});
const byId=(a,id)=> a.find(x=>x.id===id);
const sumInv=id=> state.invoices.filter(x=>x.supplierId===id).reduce((a,b)=>a+Number(b.amount||0),0);
const sumPay=id=> state.payments.filter(x=>x.supplierId===id).reduce((a,b)=>a+Number(b.amount||0),0);
const balance=id=> (byId(state.suppliers,id)?.opening||0)+sumInv(id)-sumPay(id);
const nextId=(a)=> a.length? Math.max(...a.map(x=>x.id))+1 : 1;

function refreshSupplierSelects(){
  const opts=state.suppliers.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  document.getElementById('selSupplier').innerHTML=opts;
  const isup=document.getElementById('isup'); if(isup) isup.innerHTML='<option disabled selected>اختر...</option>'+opts;
  const psup=document.getElementById('psup'); if(psup) psup.innerHTML='<option disabled selected>اختر...</option>'+opts;
  const calSup=document.getElementById('calSup'); if(calSup) calSup.innerHTML=opts;
}
function renderSummary(){
  const id=Number(document.getElementById('selSupplier').value);
  const s=byId(state.suppliers,id);
  document.getElementById('sumInv').textContent=fmt(sumInv(id));
  document.getElementById('sumPay').textContent=fmt(sumPay(id));
  document.getElementById('open').textContent=fmt(s?.opening||0);
  document.getElementById('bal').textContent=fmt(balance(id));
}
function renderSuppliers(){
  const q = (document.getElementById('supSearch')?.value || '').trim();
  const rows = q ? state.suppliers.filter(s=> s.name.includes(q)) : state.suppliers;
  document.getElementById('supBody').innerHTML = rows.map((s,i)=>`
    <tr>
      <td>${i+1}</td><td>${s.name}</td><td class="currency">${fmt(s.opening||0)}</td>
      <td>${s.rep||''}</td><td>${s.notes||''}</td>
      <td>
        <button class="btn btn-sm btn-outline-secondary me-1" onclick="editSup(${s.id})"><i class="bi bi-pencil"></i></button>
        <button class="btn btn-sm btn-outline-danger" onclick="delSup(${s.id})"><i class="bi bi-trash"></i></button>
      </td>
    </tr>`).join('');
}
function renderInvoices(){
  document.getElementById('invBody').innerHTML=state.invoices.map(x=>`
    <tr>
      <td>${x.date}</td><td>${x.number||''}</td><td>${byId(state.suppliers,x.supplierId)?.name||''}</td>
      <td class="currency">${fmt(x.amount)}</td><td>${x.note||''}</td>
      <td><button class="btn btn-sm btn-outline-danger" onclick="delInv(${x.id})"><i class="bi bi-trash"></i></button></td>
    </tr>`).join('');
}
function renderPayments(){
  document.getElementById('payBody').innerHTML=state.payments.map(x=>`
    <tr>
      <td>${x.date}</td><td>${byId(state.suppliers,x.supplierId)?.name||''}</td><td>${x.rep||''}</td>
      <td class="currency">${fmt(x.amount)}</td><td>${x.method||''}</td><td>${x.note||''}</td>
      <td><button class="btn btn-sm btn-outline-danger" onclick="delPay(${x.id})"><i class="bi bi-trash"></i></button></td>
    </tr>`).join('');
}
function renderReport(){
  const rows = state.suppliers.map(s=>{
    const inv=sumInv(s.id), pay=sumPay(s.id), bal=(s.opening||0)+inv-pay;
    return {name:s.name, inv, pay, open:s.opening||0, bal};
  });
  const debtTotal = rows.map(r=>r.bal).filter(x=>x>0).reduce((a,b)=>a+b,0);
  const payTotal = rows.map(r=>r.pay).reduce((a,b)=>a+b,0);
  const grandBal = rows.map(r=>r.bal).reduce((a,b)=>a+b,0);
  document.getElementById('rDebt').textContent=fmt(debtTotal);
  document.getElementById('rPays').textContent=fmt(payTotal);
  document.getElementById('rBal').textContent=fmt(grandBal);
  document.getElementById('rBody').innerHTML = rows.map(r=>`
    <tr><td>${r.name}</td><td class="currency">${fmt(r.inv)}</td>
    <td class="currency">${fmt(r.pay)}</td><td class="currency">${fmt(r.open)}</td>
    <td class="currency">${fmt(r.bal)}</td></tr>`).join('');
}
function renderCalendar(){
  const map = {sat:'#d-sat',sun:'#d-sun',mon:'#d-mon',tue:'#d-tue',wed:'#d-wed',thu:'#d-thu',fri:'#d-fri'};
  Object.entries(map).forEach(([k,sel])=>{
    const wrap = document.querySelector(sel);
    const arr = (state.week?.[k] || []);
    wrap.innerHTML = arr.map(id=>{
      const s = byId(state.suppliers, id);
      if(!s) return '';
      return `<span class="chip pointer" title="عرض ملخص ${s.name}" onclick="openSupplier(${id})">${s.name}<span class="x text-danger ms-1" onclick="event.stopPropagation(); removeFromDay('${k}', ${id})">&times;</span></span>`;
    }).join('');
  });
}
function renderPaymentsByDate(){
  const d = document.getElementById('filterDate').value;
  if(!d){ document.getElementById('paymentsByDate').innerHTML=''; return; }
  const list = state.payments.filter(x=>x.date===d);
  if(!list.length){ document.getElementById('paymentsByDate').innerHTML='<div class="text-muted">لا توجد دفعات في هذا التاريخ.</div>'; return; }
  const total = list.reduce((a,b)=>a+Number(b.amount||0),0);
  document.getElementById('paymentsByDate').innerHTML = list.map(x=>{
    const s=byId(state.suppliers,x.supplierId)?.name||'';
    return `<div>• <strong class="currency">${fmt(x.amount)}</strong> — ${s} — مندوب: ${x.rep||'-'} — ${x.method||''}</div>`;
  }).join('') + `<hr class="my-2"><div><strong>المجموع:</strong> <span class="currency">${fmt(total)}</span></div>`;
}
function renderGlobalReport(){
  const sumBalances = state.suppliers
    .map(s=> (s.opening||0) + state.invoices.filter(i=>i.supplierId===s.id).reduce((a,b)=>a+Number(b.amount||0),0)
               - state.payments.filter(p=>p.supplierId===s.id).reduce((a,b)=>a+Number(b.amount||0),0))
    .reduce((a,b)=>a+b,0);
  document.getElementById('grTotalBalances').textContent = fmt(sumBalances);
  const totalPays = state.payments.reduce((a,b)=>a+Number(b.amount||0),0);
  document.getElementById('grTotalPayments').textContent = fmt(totalPays);
  document.getElementById('grPaymentsBody').innerHTML = state.payments.map(x=>{
    const s=byId(state.suppliers,x.supplierId)?.name||'';
    return `<tr><td>${x.date}</td><td>${s}</td><td>${x.rep||''}</td><td>${x.method||''}</td><td class="currency">${fmt(x.amount)}</td><td>${x.note||''}</td></tr>`;
  }).join('');
}
function openSupplier(id){
  const sel = document.getElementById('selSupplier');
  if(sel){ sel.value = String(id); renderSummary(); }
  try{ document.querySelector('main').scrollIntoView({behavior:'smooth', block:'start'}); }catch(_){}
}
function rerender(){ refreshSupplierSelects(); renderSummary(); renderSuppliers(); renderInvoices(); renderPayments(); renderReport(); renderCalendar(); renderPaymentsByDate(); }

async function addOrUpdateSupplier(s){ await wsCol('suppliers').doc(String(s.id)).set(s, { merge:true }); }
async function deleteSupplier(id){
  await wsCol('suppliers').doc(String(id)).delete();
  const inv = await wsCol('invoices').where('supplierId','==',id).get(); inv.forEach(d=> wsCol('invoices').doc(d.id).delete());
  const pay = await wsCol('payments').where('supplierId','==',id).get(); pay.forEach(d=> wsCol('payments').doc(d.id).delete());
  const wdoc = await wsDoc('week').get();
  const w = wdoc.data() || {sat:[],sun:[],mon:[],tue:[],wed:[],thu:[],fri:[]};
  Object.keys(w).forEach(k => w[k] = (w[k]||[]).filter(v=>v!==id));
  await wsDoc('week').set(w);
}
async function addOrUpdateInvoice(it){ await wsCol('invoices').doc(String(it.id)).set(it, { merge:true }); }
async function deleteInvoice(id){ await wsCol('invoices').doc(String(id)).delete(); }
async function addOrUpdatePayment(it){ await wsCol('payments').doc(String(it.id)).set(it, { merge:true }); }
async function deletePayment(id){ await wsCol('payments').doc(String(id)).delete(); }
async function saveWeek(w){ await wsDoc('week').set(w); }

document.body.insertAdjacentHTML('beforeend', `
<div class="modal fade" id="mSupplier" tabindex="-1"><div class="modal-dialog"><form class="modal-content" id="fSup">
  <div class="modal-header"><h5 class="modal-title">مورد جديد/تعديل</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
  <div class="modal-body">
    <input type="hidden" id="sid">
    <div class="form-floating mb-2"><input id="sname" class="form-control" placeholder="اسم المورد" required><label>اسم المورد</label></div>
    <div class="form-floating mb-2"><input type="number" id="sopen" class="form-control" value="0"><label>رصيد افتتاحي</label></div>
    <div class="form-floating mb-2"><input id="srep" class="form-control" placeholder="اسم المندوب"><label>اسم المندوب</label></div>
    <div class="form-floating"><input id="snote" class="form-control" placeholder="ملاحظات"><label>ملاحظات</label></div>
  </div>
  <div class="modal-footer"><button class="btn btn-primary">حفظ</button></div>
</form></div></div>

<div class="modal fade" id="mInvoice" tabindex="-1"><div class="modal-dialog"><form class="modal-content" id="fInv">
  <div class="modal-header"><h5 class="modal-title">إضافة فاتورة</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
  <div class="modal-body">
    <input type="hidden" id="iid">
    <div class="form-floating mb-2"><input type="date" id="idate" class="form-control" required><label>التاريخ</label></div>
    <div class="form-floating mb-2"><input id="ino" class="form-control" placeholder="رقم الفاتورة"><label>رقم الفاتورة</label></div>
    <div class="mb-2"><label class="form-label">المورد</label><select id="isup" class="form-select" required></select></div>
    <div class="form-floating mb-2"><input type="number" id="iamt" class="form-control" step="0.01" min="0" required><label>المبلغ</label></div>
    <div class="form-floating"><input id="inote" class="form-control" placeholder="ملاحظات"><label>ملاحظات</label></div>
  </div>
  <div class="modal-footer"><button class="btn btn-primary">حفظ</button></div>
</form></div></div>

<div class="modal fade" id="mPayment" tabindex="-1"><div class="modal-dialog"><form class="modal-content" id="fPay">
  <div class="modal-header"><h5 class="modal-title">إضافة دفعة</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
  <div class="modal-body">
    <input type="hidden" id="pid">
    <div class="form-floating mb-2"><input type="date" id="pdate" class="form-control" required><label>التاريخ</label></div>
    <div class="mb-2"><label class="form-label">المورد</label><select id="psup" class="form-select" required></select></div>
    <div class="form-floating mb-2"><input type="number" id="pamt" class="form-control" step="0.01" min="0" required><label>المبلغ</label></div>
    <div class="form-floating mb-2"><input id="pmethod" class="form-control" placeholder="طريقة الدفع (نقدي/تحويل/شيك)"><label>طريقة الدفع</label></div>
    <div class="form-floating mb-2"><input id="prep" class="form-control" placeholder="اسم المندوب"><label>اسم المندوب</label></div>
    <div class="form-floating"><input id="pnote" class="form-control" placeholder="ملاحظات"><label>ملاحظات</label></div>
  </div>
  <div class="modal-footer"><button class="btn btn-success">حفظ</button></div>
</form></div></div>
`);

document.addEventListener('submit', async (e)=>{
  if(e.target.id==='fSup'){ e.preventDefault();
    const id = document.getElementById('sid').value ? Number(document.getElementById('sid').value) : nextId(state.suppliers);
    const s = { id,
      name: document.getElementById('sname').value.trim(),
      opening: Number(document.getElementById('sopen').value||0),
      rep: document.getElementById('srep').value.trim(),
      notes: document.getElementById('snote').value.trim()
    };
    await addOrUpdateSupplier(s);
    bootstrap.Modal.getInstance(document.getElementById('mSupplier')).hide();
    e.target.reset();
  }
  if(e.target.id==='fInv'){ e.preventDefault();
    const id = document.getElementById('iid').value ? Number(document.getElementById('iid').value) : nextId(state.invoices);
    const it = { id,
      date: document.getElementById('idate').value || today(),
      number: document.getElementById('ino').value.trim(),
      supplierId: Number(document.getElementById('isup').value),
      amount: Number(document.getElementById('iamt').value||0),
      note: document.getElementById('inote').value.trim()
    };
    await addOrUpdateInvoice(it);
    bootstrap.Modal.getInstance(document.getElementById('mInvoice')).hide();
    e.target.reset();
  }
  if(e.target.id==='fPay'){ e.preventDefault();
    const id = document.getElementById('pid').value ? Number(document.getElementById('pid').value) : nextId(state.payments);
    const it = { id,
      date: document.getElementById('pdate').value || today(),
      supplierId: Number(document.getElementById('psup').value),
      amount: Number(document.getElementById('pamt').value||0),
      method: document.getElementById('pmethod').value.trim(),
      rep: document.getElementById('prep').value.trim(),
      note: document.getElementById('pnote').value.trim()
    };
    await addOrUpdatePayment(it);
    bootstrap.Modal.getInstance(document.getElementById('mPayment')).hide();
    e.target.reset();
  }
});

async function delSup(id){ if(!confirm('حذف المورد وكل حركاته؟')) return; await deleteSupplier(id); }
async function delInv(id){ if(!confirm('حذف الفاتورة؟')) return; await deleteInvoice(id); }
async function delPay(id){ if(!confirm('حذف الدفعة؟')) return; await deletePayment(id); }

document.addEventListener('DOMContentLoaded', ()=>{
  if ('serviceWorker' in navigator) navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
  document.getElementById('filterDate').addEventListener('change', renderPaymentsByDate);
  document.getElementById('supSearch').addEventListener('input', renderSuppliers);
  document.getElementById('mGlobalReport').addEventListener('show.bs.modal', renderGlobalReport);
});
</script>
</body>
</html>
