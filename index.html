<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>دفتر بسيط للموردين</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<style>
  body{background:#f7f7fb}
  .card{box-shadow:0 6px 18px rgba(0,0,0,.06); border:none}
  .stat{font-weight:800; font-size:1.4rem}
  .currency::after{content:" شيقل"; color:#666; font-weight:500}
  .table thead th{position:sticky; top:0; background:#fff; z-index:1}
  .brand{font-weight:800}
</style>
</head>
<body>
<nav class="navbar bg-white border-bottom sticky-top">
  <div class="container-fluid">
    <span class="navbar-brand brand"><i class="bi bi-clipboard-check me-2"></i>دفتر بسيط للموردين</span>
    <button class="btn btn-outline-secondary btn-sm" onclick="backup()"><i class="bi bi-cloud-download"></i> نسخة</button>
    <label class="btn btn-outline-secondary btn-sm mb-0">
      <i class="bi bi-cloud-upload"></i> استعادة
      <input type="file" id="restore" hidden accept="application/json">
    </label>
  </div>
</nav>

<main class="container my-4">
  <div class="row g-3">
    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title mb-3">ملخص سريع</h5>
          <div class="mb-3">
            <label class="form-label">المورد</label>
            <select id="sel" class="form-select"></select>
          </div>
          <div class="row g-2 text-center">
            <div class="col-6"><div class="p-3 border rounded">
              <div class="text-muted">إجمالي الفواتير</div><div id="sumInv" class="stat currency">0</div></div></div>
            <div class="col-6"><div class="p-3 border rounded">
              <div class="text-muted">إجمالي الدفعات</div><div id="sumPay" class="stat currency">0</div></div></div>
            <div class="col-6"><div class="p-3 border rounded">
              <div class="text-muted">الرصيد الافتتاحي</div><div id="open" class="stat currency">0</div></div></div>
            <div class="col-6"><div class="p-3 border rounded">
              <div class="text-muted">الرصيد الحالي</div><div id="bal" class="stat currency">0</div></div></div>
          </div>
          <div class="d-grid gap-2 mt-3">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#mInvoice"><i class="bi bi-receipt"></i> إضافة فاتورة</button>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#mPayment"><i class="bi bi-cash-coin"></i> إضافة دفعة</button>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-8">
      <div class="card">
        <div class="card-body">
          <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tSup">الموردون</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tInv">الفواتير</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tPay">الدفعات</button></li>
          </ul>
          <div class="tab-content pt-3">
            <div class="tab-pane fade show active" id="tSup">
              <div class="d-flex gap-2 mb-2">
                <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#mSup"><i class="bi bi-person-plus"></i> إضافة مورد</button>
                <button id="seed" class="btn btn-outline-secondary btn-sm"><i class="bi bi-lightning"></i> مثال تلقائي</button>
                <button id="wipe" class="btn btn-outline-danger btn-sm"><i class="bi bi-trash3"></i> حذف الكل</button>
              </div>
              <div class="table-responsive" style="max-height:430px">
                <table class="table table-hover align-middle">
                  <thead class="table-light"><tr><th>#</th><th>الاسم</th><th>رصيد افتتاحي</th><th>ملاحظات</th><th>إجراءات</th></tr></thead>
                  <tbody id="supBody"></tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="tInv">
              <div class="table-responsive" style="max-height:430px">
                <table class="table table-striped align-middle">
                  <thead class="table-light"><tr><th>التاريخ</th><th>الفاتورة</th><th>المورد</th><th>المبلغ</th><th>ملاحظات</th><th>إجراءات</th></tr></thead>
                  <tbody id="invBody"></tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="tPay">
              <div class="table-responsive" style="max-height:430px">
                <table class="table table-striped align-middle">
                  <thead class="table-light"><tr><th>التاريخ</th><th>المورد</th><th>المبلغ</th><th>طريقة</th><th>ملاحظات</th><th>إجراءات</th></tr></thead>
                  <tbody id="payBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Modals -->
<div class="modal fade" id="mSup" tabindex="-1"><div class="modal-dialog">
  <form class="modal-content" id="fSup">
    <div class="modal-header"><h5 class="modal-title">مورد جديد/تعديل</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <input type="hidden" id="sid">
      <div class="form-floating mb-2"><input id="sname" class="form-control" placeholder="اسم المورد" required><label>اسم المورد</label></div>
      <div class="form-floating mb-2"><input type="number" id="sopen" class="form-control" value="0" placeholder="رصيد افتتاحي"><label>رصيد افتتاحي</label></div>
      <div class="form-floating"><input id="snote" class="form-control" placeholder="ملاحظات"><label>ملاحظات</label></div>
    </div>
    <div class="modal-footer"><button class="btn btn-primary">حفظ</button></div>
  </form></div></div>

<div class="modal fade" id="mInvoice" tabindex="-1"><div class="modal-dialog">
  <form class="modal-content" id="fInv">
    <div class="modal-header"><h5 class="modal-title">إضافة فاتورة</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <input type="hidden" id="iid">
      <div class="form-floating mb-2"><input type="date" id="idate" class="form-control" required><label>التاريخ</label></div>
      <div class="form-floating mb-2"><input id="ino" class="form-control" placeholder="رقم الفاتورة"><label>رقم الفاتورة</label></div>
      <div class="mb-2"><label class="form-label">المورد</label><select id="isup" class="form-select" required></select></div>
      <div class="form-floating mb-2"><input type="number" id="iamt" class="form-control" step="0.01" min="0" required placeholder="المبلغ"><label>المبلغ</label></div>
      <div class="form-floating"><input id="inote" class="form-control" placeholder="ملاحظات"><label>ملاحظات</label></div>
    </div>
    <div class="modal-footer"><button class="btn btn-primary">حفظ</button></div>
  </form></div></div>

<div class="modal fade" id="mPayment" tabindex="-1"><div class="modal-dialog">
  <form class="modal-content" id="fPay">
    <div class="modal-header"><h5 class="modal-title">إضافة دفعة</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <input type="hidden" id="pid">
      <div class="form-floating mb-2"><input type="date" id="pdate" class="form-control" required><label>التاريخ</label></div>
      <div class="mb-2"><label class="form-label">المورد</label><select id="psup" class="form-select" required></select></div>
      <div class="form-floating mb-2"><input type="number" id="pamt" class="form-control" step="0.01" min="0" required placeholder="المبلغ"><label>المبلغ</label></div>
      <div class="form-floating mb-2"><input id="pmethod" class="form-control" placeholder="طريقة الدفع (نقدي/تحويل)"><label>طريقة الدفع</label></div>
      <div class="form-floating"><input id="pnote" class="form-control" placeholder="ملاحظات"><label>ملاحظات</label></div>
    </div>
    <div class="modal-footer"><button class="btn btn-success">حفظ</button></div>
  </form></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ------- Data Store -------
const KEY='simple_ledger_v1';
function load(){ try{return JSON.parse(localStorage.getItem(KEY))||{suppliers:[], invoices:[], payments:[]};}catch(_){return{suppliers:[], invoices:[], payments:[]}}}
function save(){ localStorage.setItem(KEY, JSON.stringify(db)); }
let db = load();

// Helpers
const $=s=>document.querySelector(s);
const today=()=> new Date().toISOString().slice(0,10);
const fmt=n=> Number(n||0).toLocaleString('ar-EG',{maximumFractionDigits:2});
const nextId=a=> a.length? Math.max(...a.map(x=>x.id))+1 : 1;
const byId=(a,id)=> a.find(x=>x.id===id);
const sumInv=id=> db.invoices.filter(x=>x.supplierId===id).reduce((a,b)=>a+Number(b.amount||0),0);
const sumPay=id=> db.payments.filter(x=>x.supplierId===id).reduce((a,b)=>a+Number(b.amount||0),0);
const balance=id=> (byId(db.suppliers,id)?.opening||0)+sumInv(id)-sumPay(id);

// UI bindings
function refreshSelects(){
  const opts=db.suppliers.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  $('#sel').innerHTML=opts;
  $('#isup').innerHTML='<option disabled selected>اختر...</option>'+opts;
  $('#psup').innerHTML='<option disabled selected>اختر...</option>'+opts;
}

function renderSummary(){
  const id=Number($('#sel').value);
  const s=byId(db.suppliers,id); if(!s){ $('#sumInv').textContent='0'; $('#sumPay').textContent='0'; $('#open').textContent='0'; $('#bal').textContent='0'; return;}
  $('#sumInv').textContent=fmt(sumInv(id));
  $('#sumPay').textContent=fmt(sumPay(id));
  $('#open').textContent=fmt(s.opening||0);
  $('#bal').textContent=fmt(balance(id));
}

function renderSuppliers(){
  $('#supBody').innerHTML=db.suppliers.map((s,i)=>`
    <tr>
      <td>${i+1}</td>
      <td>${s.name}</td>
      <td class="currency">${fmt(s.opening||0)}</td>
      <td>${s.notes||''}</td>
      <td>
        <button class="btn btn-sm btn-outline-secondary me-1" onclick="editSup(${s.id})"><i class="bi bi-pencil"></i></button>
        <button class="btn btn-sm btn-outline-danger" onclick="delSup(${s.id})"><i class="bi bi-trash"></i></button>
      </td>
    </tr>`).join('');
}

function renderInvoices(){
  $('#invBody').innerHTML=db.invoices.map(x=>`
    <tr>
      <td>${x.date}</td><td>${x.number||''}</td><td>${byId(db.suppliers,x.supplierId)?.name||''}</td>
      <td class="currency">${fmt(x.amount)}</td><td>${x.note||''}</td>
      <td>
        <button class="btn btn-sm btn-outline-secondary me-1" onclick="editInv(${x.id})"><i class="bi bi-pencil"></i></button>
        <button class="btn btn-sm btn-outline-danger" onclick="delInv(${x.id})"><i class="bi bi-trash"></i></button>
      </td>
    </tr>`).join('');
}

function renderPayments(){
  $('#payBody').innerHTML=db.payments.map(x=>`
    <tr>
      <td>${x.date}</td><td>${byId(db.suppliers,x.supplierId)?.name||''}</td>
      <td class="currency">${fmt(x.amount)}</td><td>${x.method||''}</td><td>${x.note||''}</td>
      <td>
        <button class="btn btn-sm btn-outline-secondary me-1" onclick="editPay(${x.id})"><i class="bi bi-pencil"></i></button>
        <button class="btn btn-sm btn-outline-danger" onclick="delPay(${x.id})"><i class="bi bi-trash"></i></button>
      </td>
    </tr>`).join('');
}

function rerender(){ refreshSelects(); renderSummary(); renderSuppliers(); renderInvoices(); renderPayments(); save(); }

// Supplier CRUD
function editSup(id){ const s=byId(db.suppliers,id);
  $('#sid').value=s.id; $('#sname').value=s.name; $('#sopen').value=s.opening||0; $('#snote').value=s.notes||'';
  new bootstrap.Modal('#mSup').show();
}
function delSup(id){
  if(!confirm('حذف المورد وكل حركاته؟')) return;
  db.invoices=db.invoices.filter(x=>x.supplierId!==id);
  db.payments=db.payments.filter(x=>x.supplierId!==id);
  db.suppliers=db.suppliers.filter(x=>x.id!==id);
  rerender();
}
document.querySelector('#fSup').addEventListener('submit',e=>{
  e.preventDefault();
  const id=$('#sid').value? Number($('#sid').value): nextId(db.suppliers);
  const s={id, name:$('#sname').value.trim(), opening:Number($('#sopen').value||0), notes:$('#snote').value.trim()};
  const i=db.suppliers.findIndex(x=>x.id===id); if(i>=0) db.suppliers[i]=s; else db.suppliers.push(s);
  bootstrap.Modal.getInstance(document.querySelector('#mSup')).hide();
  e.target.reset(); rerender();
});

// Invoice CRUD
function editInv(id){ const x=db.invoices.find(v=>v.id===id);
  $('#iid').value=x.id; $('#idate').value=x.date; $('#ino').value=x.number||''; $('#isup').value=x.supplierId; $('#iamt').value=x.amount; $('#inote').value=x.note||'';
  new bootstrap.Modal('#mInvoice').show();
}
function delInv(id){ if(!confirm('حذف الفاتورة؟')) return; db.invoices=db.invoices.filter(x=>x.id!==id); rerender(); }
document.querySelector('#fInv').addEventListener('submit',e=>{
  e.preventDefault();
  const id=$('#iid').value? Number($('#iid').value): nextId(db.invoices);
  const it={id, date:$('#idate').value||today(), number:$('#ino').value.trim(), supplierId:Number($('#isup').value),
            amount:Number($('#iamt').value||0), note:$('#inote').value.trim()};
  const i=db.invoices.findIndex(x=>x.id===id); if(i>=0) db.invoices[i]=it; else db.invoices.push(it);
  bootstrap.Modal.getInstance(document.querySelector('#mInvoice')).hide();
  e.target.reset(); rerender();
});

// Payment CRUD
function editPay(id){ const x=db.payments.find(v=>v.id===id);
  $('#pid').value=x.id; $('#pdate').value=x.date; $('#psup').value=x.supplierId; $('#pamt').value=x.amount; $('#pmethod').value=x.method||''; $('#pnote').value=x.note||'';
  new bootstrap.Modal('#mPayment').show();
}
function delPay(id){ if(!confirm('حذف الدفعة؟')) return; db.payments=db.payments.filter(x=>x.id!==id); rerender(); }
document.querySelector('#fPay').addEventListener('submit',e=>{
  e.preventDefault();
  const id=$('#pid').value? Number($('#pid').value): nextId(db.payments);
  const it={id, date:$('#pdate').value||today(), supplierId:Number($('#psup').value),
            amount:Number($('#pamt').value||0), method:$('#pmethod').value.trim(), note:$('#pnote').value.trim()};
  const i=db.payments.findIndex(x=>x.id===id); if(i>=0) db.payments[i]=it; else db.payments.push(it);
  bootstrap.Modal.getInstance(document.querySelector('#mPayment')).hide();
  e.target.reset(); rerender();
});

// Backup/restore
function backup(){
  const blob=new Blob([JSON.stringify(db,null,2)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='backup_دفتر_بسيط.json'; a.click();
}
document.querySelector('#restore').addEventListener('change',e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader(); r.onload=()=>{ try{ const o=JSON.parse(r.result); if(o.suppliers&&o.invoices&&o.payments){ db=o; rerender(); alert('تمت الاستعادة.'); } else alert('ملف غير صالح.'); } catch(_){ alert('ملف غير صالح.'); } };
  r.readAsText(f);
});

// Seed, Wipe
document.querySelector('#seed').addEventListener('click',()=>{
  if(!confirm('إضافة مثال تلقائي؟')) return;
  db.suppliers.push({id:nextId(db.suppliers), name:'عبد الله الدين', opening:1000, notes:''});
  rerender();
});
document.querySelector('#wipe').addEventListener('click',()=>{
  if(!confirm('حذف كل البيانات؟')) return;
  db={suppliers:[], invoices:[], payments:[]}; rerender();
});

// Init
window.addEventListener('DOMContentLoaded',()=>{
  if(!db.suppliers.length){ db.suppliers=[{id:1, name:'شركة جديدة', opening:0, notes:''}]; }
  document.getElementById('idate').value=today();
  document.getElementById('pdate').value=today();
  rerender();
  document.getElementById('sel').addEventListener('change',renderSummary);
});
</script>
</body>
</html>
