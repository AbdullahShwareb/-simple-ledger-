<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>محلات أيمن أبو الشوارب —   </title>
<style>
:root{ --bg:#f7f7fb; --card:#fff; --txt:#111; --muted:#6b7280; --line:#e5e7eb; --pri:#2563eb; --ok:#16a34a; --warn:#b45309; }
*{ box-sizing:border-box; }
body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Kufi Arabic', Tahoma, Arial; background:var(--bg); color:var(--txt) }
.topbar{ position:sticky; top:0; background:#fff; border-bottom:1px solid var(--line); padding:.6rem .9rem; display:flex; align-items:center; justify-content:space-between; z-index:10 }
.brand{ font-weight:800 }
actions{ display:flex; gap:.5rem; align-items:center }
.container{ padding:1rem }
.grid{ display:grid; gap:1rem; grid-template-columns: 1fr; }
@media(min-width:1000px){ .grid{ grid-template-columns: 340px 1fr; } }
.card{ background:var(--card); border:1px solid var(--line); border-radius:.8rem; padding:1rem; box-shadow:0 8px 20px rgba(0,0,0,.04) }
.card-head{ display:flex; align-items:center; justify-content:space-between }
.field{ margin:.6rem 0; display:flex; flex-direction:column; gap:.3rem }
.field input, .field select{ border:1px solid var(--line); border-radius:.5rem; padding:.55rem .7rem; outline:none }
.field input:focus, .field select:focus{ border-color:var(--pri) }
.stats{ display:grid; grid-template-columns:repeat(2,1fr); gap:.5rem; margin:.6rem 0 }
.stat{ background:#f8fafc; border:1px solid var(--line); border-radius:.6rem; padding:.8rem }
.muted{ color:var(--muted); font-size:.85rem }
.num::after{ content:" شيقل"; color:var(--muted); font-weight:500 }
.row-btns{ display:flex; flex-wrap:wrap; gap:.5rem; margin-top:.4rem }
.btn{ border:1px solid var(--line); background:#fff; border-radius:.6rem; padding:.5rem .75rem; cursor:pointer }
.btn:hover{ background:#f3f4f6 }
.btn.primary{ background:var(--pri); color:#fff; border-color:transparent }
.btn.success{ background:var(--ok); color:#fff; border-color:transparent }
.btn.ghost{ background:#fff; color:#111 }
.input{ border:1px solid var(--line); border-radius:.5rem; padding:.5rem .7rem; }
.table-wrap{ max-height:380px; overflow:auto; border:1px solid var(--line); border-radius:.6rem }
.table{ width:100%; border-collapse:collapse }
.table th, .table td{ padding:.6rem .5rem; border-bottom:1px solid var(--line); text-align:right; vertical-align:middle }
.table small{ color:var(--muted) }
.week{ display:grid; grid-template-columns: repeat(2,1fr); gap:.5rem }
@media(min-width:900px){ .week{ grid-template-columns: repeat(3,1fr); } }
.day{ background:#fff; border:1px solid var(--line); border-radius:.6rem; padding:.5rem; min-height:84px }
.chip{ display:inline-flex; align-items:center; gap:.35rem; background:#e9f2ff; border:1px solid #cfe4ff; padding:.25rem .6rem; border-radius:50rem; margin:.25rem .25rem 0 0; font-size:.9rem }
.chip .x{ cursor:pointer; color:#b91c1c }
.small{ font-size:.9rem }
.grid-3{ display:grid; grid-template-columns:repeat(3,1fr); gap:.5rem }
.grid-2{ display:grid; grid-template-columns:repeat(2,1fr); gap:.5rem }
.pill{ background:#f8fafc; border:1px solid var(--line); border-radius:.6rem; padding:.8rem }
.mt{ margin-top:.8rem }
.toolbar{ display:flex; gap:.5rem; align-items:center; margin:.3rem 0 }
.tabs{ display:flex; gap:.4rem; border-bottom:1px solid var(--line); margin-bottom:.6rem }
.tab{ background:#fff; border:1px solid var(--line); border-bottom:none; border-radius:.6rem .6rem 0 0; padding:.4rem .7rem; cursor:pointer }
.tab.active{ background:#eef2ff; color:#1e40af }
.tabcontent{ display:none }
.tabcontent.show{ display:block }
.modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.25); z-index:100 }
.modal.show{ display:flex }
.modal-box{ background:#fff; width:min(520px,92vw); border-radius:.8rem; padding:1rem; border:1px solid var(--line) }
.filelabel{ position:relative }
.filelabel input{ position:absolute; inset:0; opacity:0; cursor:pointer }
</style>
</head>
<body>
<nav class="topbar">
  <div class="brand">محلات أيمن أبو الشوارب — نسخة سحابية (Google Sheets)</div>
  <div class="actions">
    <button id="btnExport" class="btn ghost">تصدير النسخة الاحتياطية</button>
    <label class="btn ghost filelabel">استيراد<input id="importFile" type="file" accept=".json" hidden></label>
  </div>
</nav>

<main class="container">
  <section class="grid">
    <div class="card">
      <h2>ملخص سريع</h2>
      <div class="field"><label>المورد</label><select id="selSupplier"></select></div>
      <div class="stats">
        <div class="stat"><div class="muted">إجمالي الفواتير</div><div id="sumInv" class="num">0</div></div>
        <div class="stat"><div class="muted">إجمالي الدفعات</div><div id="sumPay" class="num">0</div></div>
        <div class="stat"><div class="muted">الافتتاحي</div><div id="open" class="num">0</div></div>
        <div class="stat"><div class="muted">الرصيد الحالي</div><div id="bal" class="num">0</div></div>
      </div>
      <div class="row-btns">
        <button id="addInvoice" class="btn primary">إضافة فاتورة</button>
        <button id="addPayment" class="btn success">إضافة دفعة</button>
        <button id="addSupplier" class="btn">إضافة/تعديل مورد</button>
      </div>
      <hr>
      <div class="field"><label>إظهار الدفعات بتاريخ</label><input type="date" id="filterDate"></div>
      <div id="paymentsByDate" class="small"></div>
    </div>

    <div class="card">
      <div class="card-head"><h2>تقويم الأسبوع</h2><button id="addToCal" class="btn ghost">إضافة إلى التقويم</button></div>
      <div class="week">
        <div class="day"><div class="muted">السبت</div><div id="d-sat"></div></div>
        <div class="day"><div class="muted">الأحد</div><div id="d-sun"></div></div>
        <div class="day"><div class="muted">الاثنين</div><div id="d-mon"></div></div>
        <div class="day"><div class="muted">الثلاثاء</div><div id="d-tue"></div></div>
        <div class="day"><div class="muted">الأربعاء</div><div id="d-wed"></div></div>
        <div class="day"><div class="muted">الخميس</div><div id="d-thu"></div></div>
        <div class="day"><div class="muted">الجمعة</div><div id="d-fri"></div></div>
      </div>
    </div>

    <div class="card">
      <div class="tabs">
        <button class="tab active" data-target="#tSup">الموردون</button>
        <button class="tab" data-target="#tInv">الفواتير</button>
        <button class="tab" data-target="#tPay">الدفعات</button>
        <button class="tab" data-target="#tRpt">تقرير</button>
      </div>

      <div class="tabcontent show" id="tSup">
        <div class="toolbar">
          <input id="supSearch" class="input" placeholder="ابحث عن اسم المورد...">
          <button id="btnGlobalReport" class="btn ghost">تقرير شامل</button>
        </div>
        <div class="table-wrap">
          <table class="table">
            <thead><tr><th>#</th><th>الاسم</th><th>افتتاحي</th><th>مندوب</th><th>ملاحظات</th><th></th></tr></thead>
            <tbody id="supBody"></tbody>
          </table>
        </div>
      </div>

      <div class="tabcontent" id="tInv">
        <div class="table-wrap">
          <table class="table">
            <thead><tr><th>التاريخ</th><th>الفاتورة</th><th>المورد</th><th>المبلغ</th><th>ملاحظات</th><th></th></tr></thead>
            <tbody id="invBody"></tbody>
          </table>
        </div>
      </div>

      <div class="tabcontent" id="tPay">
        <div class="table-wrap">
          <table class="table">
            <thead><tr><th>التاريخ</th><th>المورد</th><th>المندوب</th><th>المبلغ</th><th>طريقة</th><th>ملاحظات</th><th></th></tr></thead>
            <tbody id="payBody"></tbody>
          </table>
        </div>
      </div>

      <div class="tabcontent" id="tRpt">
        <div class="grid-3">
          <div class="pill"><div class="muted">إجمالي الديون (أرصدة موجبة)</div><div id="rDebt" class="num">0</div></div>
          <div class="pill"><div class="muted">إجمالي الدفعات</div><div id="rPays" class="num">0</div></div>
          <div class="pill"><div class="muted">الرصيد الكلي</div><div id="rBal" class="num">0</div></div>
        </div>
        <div class="table-wrap">
          <table class="table">
            <thead><tr><th>المورد</th><th>إجمالي فواتير</th><th>إجمالي دفعات</th><th>افتتاحي</th><th>الرصيد الحالي</th></tr></thead>
            <tbody id="rBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Modals -->
<div class="modal" id="mSupplier"><div class="modal-box"><h3>مورد جديد/تعديل</h3>
<form id="fSup">
  <input type="hidden" id="sid">
  <div class="field"><label>اسم المورد</label><input id="sname" required></div>
  <div class="field"><label>رصيد افتتاحي</label><input id="sopen" type="number" value="0"></div>
  <div class="field"><label>اسم المندوب</label><input id="srep"></div>
  <div class="field"><label>ملاحظات</label><input id="snote"></div>
  <div class="row-btns"><button class="btn primary" type="submit">حفظ</button><button class="btn" type="button" data-close="#mSupplier">إلغاء</button></div>
</form></div></div>

<div class="modal" id="mInvoice"><div class="modal-box"><h3>إضافة فاتورة</h3>
<form id="fInv">
  <input type="hidden" id="iid">
  <div class="field"><label>التاريخ</label><input id="idate" type="date" required></div>
  <div class="field"><label>رقم الفاتورة</label><input id="ino"></div>
  <div class="field"><label>المورد</label><select id="isup" required></select></div>
  <div class="field"><label>المبلغ</label><input id="iamt" type="number" step="0.01" min="0" required></div>
  <div class="field"><label>ملاحظات</label><input id="inote"></div>
  <div class="row-btns"><button class="btn primary" type="submit">حفظ</button><button class="btn" type="button" data-close="#mInvoice">إلغاء</button></div>
</form></div></div>

<div class="modal" id="mPayment"><div class="modal-box"><h3>إضافة دفعة</h3>
<form id="fPay">
  <input type="hidden" id="pid">
  <div class="field"><label>التاريخ</label><input id="pdate" type="date" required></div>
  <div class="field"><label>المورد</label><select id="psup" required></select></div>
  <div class="field"><label>المبلغ</label><input id="pamt" type="number" step="0.01" min="0" required></div>
  <div class="field"><label>طريقة الدفع</label><input id="pmethod" placeholder="نقدي/تحويل/شيك"></div>
  <div class="field"><label>اسم المندوب</label><input id="prep"></div>
  <div class="field"><label>ملاحظات</label><input id="pnote"></div>
  <div class="row-btns"><button class="btn success" type="submit">حفظ</button><button class="btn" type="button" data-close="#mPayment">إلغاء</button></div>
</form></div></div>

<div class="modal" id="mCalendar"><div class="modal-box"><h3>إضافة مورد إلى يوم</h3>
<form id="fCal">
  <div class="field"><label>المورد</label><select id="calSup"></select></div>
  <div class="field"><label>اليوم</label>
    <select id="calDay">
      <option value="sat">السبت</option><option value="sun">الأحد</option><option value="mon">الاثنين</option>
      <option value="tue">الثلاثاء</option><option value="wed">الأربعاء</option><option value="thu">الخميس</option><option value="fri">الجمعة</option>
    </select>
  </div>
  <div class="row-btns"><button class="btn primary" type="submit">إضافة</button><button class="btn" type="button" data-close="#mCalendar">إغلاق</button></div>
</form></div></div>

<div class="modal" id="mGlobalReport"><div class="modal-box">
  <h3>تقرير شامل — جميع الحسابات والدفعات</h3>
  <div class="grid-2">
    <div class="pill"><div class="muted">مجموع أرصدة جميع الموردين</div><div id="grTotalBalances" class="num">0</div></div>
    <div class="pill"><div class="muted">إجمالي كل الدفعات</div><div id="grTotalPayments" class="num">0</div></div>
  </div>
  <h4 class="mt">جميع الدفعات</h4>
  <div class="table-wrap">
    <table class="table small">
      <thead><tr><th>التاريخ</th><th>المورد</th><th>المندوب</th><th>الطريقة</th><th>المبلغ</th><th>ملاحظات</th></tr></thead>
      <tbody id="grPaymentsBody"></tbody>
    </table>
  </div>
  <div class="row-btns mt"><button class="btn" data-close="#mGlobalReport">إغلاق</button></div>
</div></div>

<script>
// ===== Google Sheets Sync Layer =====
const API = 'https://script.google.com/macros/s/AKfycbxIVLQQURlHRyWfQbw3kcSFP8ytetKDETDO-kh2qirW83OrnBmqAe0JDma2k4AjjQr-5g/exec'; // Web App URL
let lastFetched = 0;

// الحالة العامة
let state = { suppliers: [], invoices: [], payments: [], week: {sat:[],sun:[],mon:[],tue:[],wed:[],thu:[],fri:[]} };

async function load(){
  try{
    const r = await fetch(API + '?op=all', {cache:'no-store'});
    const d = await r.json();
    if (d && d.state) state = d.state;
    lastFetched = new Date(d.updatedAt || Date.now()).getTime();
  }catch(e){ console.log('load error', e); }
}
async function save(){
  try{
    await fetch(API + '?op=save', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({state}) });
  }catch(e){ console.log('save error', e); }
}

// ===== Helpers / Rendering (نفس منطقك الأصلي) =====
const $ = (s, root=document)=> root.querySelector(s);
const $$ = (s, root=document)=> [...root.querySelectorAll(s)];
const today = () => new Date().toISOString().slice(0,10);
const fmt = n => Number(n||0).toLocaleString('ar-EG',{maximumFractionDigits:2});

const byId = (a,id) => a.find(x=>x.id===id);
const nextId = (a) => a.length? Math.max(...a.map(x=>x.id))+1 : 1;
const sumInv = id => state.invoices.filter(x=>x.supplierId===id).reduce((a,b)=>a+Number(b.amount||0),0);
const sumPay = id => state.payments.filter(x=>x.supplierId===id).reduce((a,b)=>a+Number(b.amount||0),0);
const balance = id => (byId(state.suppliers,id)?.opening||0) + sumInv(id) - sumPay(id);

function initTabs(){
  $$('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      $$('.tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      $$('.tabcontent').forEach(c=>c.classList.remove('show'));
      $(btn.dataset.target).classList.add('show');
    });
  });
}
function openModal(id){ $(id).classList.add('show'); }
function closeModal(id){ $(id).classList.remove('show'); }
document.addEventListener('click', (e)=>{
  const closeSel = e.target.getAttribute('data-close');
  if(closeSel) closeModal(closeSel);
  if(e.target.classList.contains('modal')) e.target.classList.remove('show');
});

function refreshSupplierSelects(){
  const opts = state.suppliers.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  $('#selSupplier').innerHTML = opts;
  $('#isup').innerHTML = '<option disabled selected>اختر...</option>' + opts;
  $('#psup').innerHTML = '<option disabled selected>اختر...</option>' + opts;
  $('#calSup').innerHTML = opts;
}
function renderSummary(){
  const id = Number($('#selSupplier').value);
  const s = byId(state.suppliers, id);
  $('#sumInv').textContent = fmt(sumInv(id));
  $('#sumPay').textContent = fmt(sumPay(id));
  $('#open').textContent = fmt(s?.opening||0);
  $('#bal').textContent = fmt(balance(id));
}
function renderSuppliers(){
  const q = ($('#supSearch')?.value || '').trim();
  const rows = q ? state.suppliers.filter(s=> s.name.includes(q)) : state.suppliers;
  $('#supBody').innerHTML = rows.map((s,i)=>`
    <tr>
      <td>${i+1}</td>
      <td>${s.name}</td>
      <td>${fmt(s.opening||0)}</td>
      <td>${s.rep||''}</td>
      <td>${s.notes||''}</td>
      <td>
        <button class="btn" onclick="editSup(${s.id})">تعديل</button>
        <button class="btn" onclick="delSup(${s.id})">حذف</button>
      </td>
    </tr>
  `).join('');
}
function renderInvoices(){
  $('#invBody').innerHTML = state.invoices.map(x=>`
    <tr>
      <td>${x.date}</td>
      <td>${x.number||''}</td>
      <td>${byId(state.suppliers,x.supplierId)?.name||''}</td>
      <td>${fmt(x.amount)}</td>
      <td>${x.note||''}</td>
      <td><button class="btn" onclick="delInv(${x.id})">حذف</button></td>
    </tr>
  `).join('');
}
function renderPayments(){
  $('#payBody').innerHTML = state.payments.map(x=>`
    <tr>
      <td>${x.date}</td>
      <td>${byId(state.suppliers,x.supplierId)?.name||''}</td>
      <td>${x.rep||''}</td>
      <td>${fmt(x.amount)}</td>
      <td>${x.method||''}</td>
      <td>${x.note||''}</td>
      <td><button class="btn" onclick="delPay(${x.id})">حذف</button></td>
    </tr>
  `).join('');
}
function renderReport(){
  const rows = state.suppliers.map(s=>{
    const inv = sumInv(s.id), pay = sumPay(s.id), bal = (s.opening||0)+inv-pay;
    return {name:s.name, inv, pay, open:s.opening||0, bal};
  });
  const debtTotal = rows.map(r=>r.bal).filter(x=>x>0).reduce((a,b)=>a+b,0);
  const payTotal = rows.map(r=>r.pay).reduce((a,b)=>a+b,0);
  const grandBal = rows.map(r=>r.bal).reduce((a,b)=>a+b,0);
  $('#rDebt').textContent = fmt(debtTotal);
  $('#rPays').textContent = fmt(payTotal);
  $('#rBal').textContent = fmt(grandBal);
  $('#rBody').innerHTML = rows.map(r=>`
    <tr>
      <td>${r.name}</td><td>${fmt(r.inv)}</td>
      <td>${fmt(r.pay)}</td><td>${fmt(r.open)}</td>
      <td>${fmt(r.bal)}</td>
    </tr>
  `).join('');
}
function renderCalendar(){
  const map = {sat:'#d-sat',sun:'#d-sun',mon:'#d-mon',tue:'#d-tue',wed:'#d-wed',thu:'#d-thu',fri:'#d-fri'};
  Object.entries(map).forEach(([k,sel])=>{
    const wrap = document.querySelector(sel);
    const arr = (state.week?.[k] || []);
    wrap.innerHTML = arr.map(id=>{
      const s = byId(state.suppliers, id);
      if(!s) return '';
      return `<span class="chip" title="عرض ملخص ${s.name}" onclick="openSupplier(${id})">${s.name}<span class="x" onclick="event.stopPropagation(); removeFromDay('${k}', ${id})">&times;</span></span>`;
    }).join('');
  });
}
function renderPaymentsByDate(){
  const d = $('#filterDate').value;
  if(!d){ $('#paymentsByDate').innerHTML=''; return; }
  const list = state.payments.filter(x=>x.date===d);
  if(!list.length){ $('#paymentsByDate').innerHTML='<div class="muted">لا توجد دفعات في هذا التاريخ.</div>'; return; }
  const total = list.reduce((a,b)=>a+Number(b.amount||0),0);
  $('#paymentsByDate').innerHTML = list.map(x=>{
    const s=byId(state.suppliers,x.supplierId)?.name||'';
    return `<div>• <strong>${fmt(x.amount)}</strong> — ${s} — مندوب: ${x.rep||'-'} — ${x.method||''}</div>`;
  }).join('') + `<hr><div><strong>المجموع:</strong> <span>${fmt(total)}</span></div>`;
}
function rerender(){
  refreshSupplierSelects();
  if ($('#selSupplier').value === "" && state.suppliers[0]) {
    $('#selSupplier').value = String(state.suppliers[0].id);
  }
  renderSummary();
  renderSuppliers();
  renderInvoices();
  renderPayments();
  renderReport();
  renderCalendar();
  renderPaymentsByDate();
}

// ===== CRUD (تكتب للشيت عبر الويب آب) =====
function addOrUpdateSupplier(s){
  const i = state.suppliers.findIndex(x=>x.id===s.id);
  if(i>-1) state.suppliers[i]=s; else state.suppliers.push(s);
  save().then(rerender);
}
function deleteSupplier(id){
  state.suppliers = state.suppliers.filter(x=>x.id!==id);
  state.invoices = state.invoices.filter(x=>x.supplierId!==id);
  state.payments = state.payments.filter(x=>x.supplierId!==id);
  Object.keys(state.week).forEach(k=> state.week[k] = (state.week[k]||[]).filter(v=>v!==id));
  save().then(rerender);
}
function addOrUpdateInvoice(it){
  const i = state.invoices.findIndex(x=>x.id===it.id);
  if(i>-1) state.invoices[i]=it; else state.invoices.push(it);
  save().then(rerender);
}
function deleteInvoice(id){
  state.invoices = state.invoices.filter(x=>x.id!==id);
  save().then(rerender);
}
function addOrUpdatePayment(it){
  const i = state.payments.findIndex(x=>x.id===it.id);
  if(i>-1) state.payments[i]=it; else state.payments.push(it);
  save().then(rerender);
}
function deletePayment(id){
  state.payments = state.payments.filter(x=>x.id!==id);
  save().then(rerender);
}
function saveWeek(w){ state.week = w; save().then(rerender); }

// expose
window.editSup = (id)=>{
  const s = byId(state.suppliers,id);
  if(!s) return;
  $('#sid').value = s.id;
  $('#sname').value = s.name;
  $('#sopen').value = s.opening||0;
  $('#srep').value = s.rep||'';
  $('#snote').value = s.notes||'';
  openModal('#mSupplier');
};
window.delSup = (id)=>{ if(confirm('حذف المورد وكل حركاته؟')) deleteSupplier(id); };
window.delInv = (id)=>{ if(confirm('حذف الفاتورة؟')) deleteInvoice(id); };
window.delPay = (id)=>{ if(confirm('حذف الدفعة؟')) deletePayment(id); };
window.removeFromDay = (k,id)=>{
  const w = {...state.week};
  w[k] = (w[k]||[]).filter(v=>v!==id);
  saveWeek(w);
};
window.openSupplier = (id)=>{
  $('#selSupplier').value = String(id);
  renderSummary();
  window.scrollTo({top:0, behavior:'smooth'});
};

document.addEventListener('submit', (e)=>{
  if(e.target.id==='fSup'){ e.preventDefault();
    const id = $('#sid').value ? Number($('#sid').value) : nextId(state.suppliers);
    const s = { id,
      name: $('#sname').value.trim(),
      opening: Number($('#sopen').value||0),
      rep: $('#srep').value.trim(),
      notes: $('#snote').value.trim()
    };
    addOrUpdateSupplier(s);
    closeModal('#mSupplier'); e.target.reset();
  }
  if(e.target.id==='fInv'){ e.preventDefault();
    const id = $('#iid').value ? Number($('#iid').value) : nextId(state.invoices);
    const it = { id,
      date: $('#idate').value || today(),
      number: $('#ino').value.trim(),
      supplierId: Number($('#isup').value),
      amount: Number($('#iamt').value||0),
      note: $('#inote').value.trim()
    };
    addOrUpdateInvoice(it);
    closeModal('#mInvoice'); e.target.reset();
  }
  if(e.target.id==='fPay'){ e.preventDefault();
    const id = $('#pid').value ? Number($('#pid').value) : nextId(state.payments);
    const it = { id,
      date: $('#pdate').value || today(),
      supplierId: Number($('#psup').value),
      amount: Number($('#pamt').value||0),
      method: $('#pmethod').value.trim(),
      rep: $('#prep').value.trim(),
      note: $('#pnote').value.trim()
    };
    addOrUpdatePayment(it);
    closeModal('#mPayment'); e.target.reset();
  }
  if(e.target.id==='fCal'){ e.preventDefault();
    const id = Number($('#calSup').value);
    const day = $('#calDay').value;
    const w = {...state.week};
    w[day] = Array.from(new Set([...(w[day]||[]), id]));
    saveWeek(w);
    closeModal('#mCalendar');
  }
});

document.getElementById('addSupplier').addEventListener('click', ()=> openModal('#mSupplier'));
document.getElementById('addInvoice').addEventListener('click', ()=> { document.getElementById('idate').value=today(); openModal('#mInvoice'); });
document.getElementById('addPayment').addEventListener('click', ()=> { document.getElementById('pdate').value=today(); openModal('#mPayment'); });
document.getElementById('addToCal').addEventListener('click', ()=> openModal('#mCalendar'));
document.getElementById('btnGlobalReport').addEventListener('click', ()=> { renderGlobalReport(); openModal('#mGlobalReport'); });
document.getElementById('filterDate').addEventListener('change', renderPaymentsByDate);
document.getElementById('supSearch').addEventListener('input', renderSuppliers);

// تصدير/استيراد (يستخدم نفس state)
document.getElementById('btnExport').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'ayman-backup.json';
  a.click();
  URL.revokeObjectURL(a.href);
});

document.getElementById('importFile').addEventListener('change', async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const txt = await f.text();
  try{ const data = JSON.parse(txt); if(data?.suppliers && data?.invoices && data?.payments){ state = data; await save(); rerender(); alert('تم الاستيراد بنجاح.'); } else { alert('ملف غير صالح'); } }
  catch{ alert('تعذر قراءة الملف'); }
});

function renderGlobalReport(){
  const sumBalances = state.suppliers
    .map(s=> (s.opening||0) + state.invoices.filter(i=>i.supplierId===s.id).reduce((a,b)=>a+Number(b.amount||0),0)
               - state.payments.filter(p=>p.supplierId===s.id).reduce((a,b)=>a+Number(b.amount||0),0))
    .reduce((a,b)=>a+b,0);
  document.getElementById('grTotalBalances').textContent = fmt(sumBalances);
  const totalPays = state.payments.reduce((a,b)=>a+Number(b.amount||0),0);
  document.getElementById('grTotalPayments').textContent = fmt(totalPays);
  document.getElementById('grPaymentsBody').innerHTML = state.payments.map(x=>{
    const s=byId(state.suppliers,x.supplierId)?.name||'';
    return `<tr><td>${x.date}</td><td>${s}</td><td>${x.rep||''}</td><td>${x.method||''}</td><td>${fmt(x.amount)}</td><td>${x.note||''}</td></tr>`;
  }).join('');
}

async function init(){
  await load();
  initTabs();
  rerender();
  // مزامنة كل 3 ثواني
  setInterval(async ()=>{
    try{
      const r = await fetch(API + '?op=all', {cache:'no-store'});
      const d = await r.json();
      const ts = new Date(d.updatedAt || 0).getTime();
      if (ts > lastFetched) { state = d.state || state; rerender(); lastFetched = ts; }
    }catch{}
  }, 3000);
}
init();
</script>
</body>
</html>
